<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lughati Hub - Multilingual Digital Storyteller</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Custom Tailwind Configuration for Moroccan Vibe -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e3a8a', // Dark Blue
                        'accent-gold': '#f59e0b', // Gold/Saffron
                        'accent-turq': '#06b6d4', // Turquoise
                        'bg-dark': '#1f2937', // Dark background
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .tab-button.active {
            background-color: #06b6d4; /* accent-turq */
            color: #1e3a8a; /* primary-blue */
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .scrollable-content {
            max-height: calc(100vh - 200px); /* Adjust based on header/footer size */
            overflow-y: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scrollable-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -3px rgba(0, 0, 0, 0.15), 0 6px 8px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-primary-blue">

    <!-- Header and Navigation -->
    <header class="sticky top-0 z-10 bg-white shadow-lg">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-primary-blue">
                <span class="text-accent-gold">Lughati</span> Hub ðŸ‡²ðŸ‡¦
            </h1>
            <div class="text-sm font-medium flex items-center space-x-2">
                <span class="text-primary-blue/70 hidden md:inline">User ID:</span>
                <span id="userIdDisplay" class="text-xs md:text-sm text-accent-turq font-mono bg-gray-100 p-1 rounded-md">Initializing...</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="bg-gray-100/80 backdrop-blur-sm shadow-inner">
            <div class="max-w-4xl mx-auto flex justify-around p-2">
                <button class="tab-button active flex-1 py-2 px-3 m-1 text-sm md:text-base rounded-full transition duration-300"
                        onclick="switchTab('translator')">
                    <i data-lucide="scan" class="inline w-5 h-5 mr-1 align-sub"></i> Darija Pro Translator
                </button>
                <button class="tab-button flex-1 py-2 px-3 m-1 text-sm md:text-base rounded-full transition duration-300"
                        onclick="switchTab('collab')">
                    <i data-lucide="messages-square" class="inline w-5 h-5 mr-1 align-sub"></i> Code-Switch Collab Arena
                </button>
                <button class="tab-button flex-1 py-2 px-3 m-1 text-sm md:text-base rounded-full transition duration-300"
                        onclick="switchTab('battle')">
                    <i data-lucide="volume-2" class="inline w-5 h-5 mr-1 align-sub"></i> Pronunciation Battle
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-4xl mx-auto p-4 md:p-6 pb-20">

        <!-- Tab Content: Darija Pro Translator -->
        <section id="translator" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-accent-gold pb-2">Darija Pro Translator: Speak Your Reality</h2>
            <div class="bg-white p-6 rounded-xl card space-y-4">
                <textarea id="translatorInput" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-accent-turq focus:border-accent-turq resize-none text-gray-800" rows="4" placeholder="Enter your Darija/French/English phrase here. Try some Arabizi! (e.g., Salam, kidayr?)"></textarea>

                <div class="flex flex-wrap gap-2 justify-center">
                    <label class="font-medium text-sm">Target Persona:</label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="persona" value="Formal" checked class="form-radio text-primary-blue">
                        <span class="ml-2">Formal (SA/French)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="persona" value="Corporate" class="form-radio text-primary-blue">
                        <span class="ml-2">Corporate (English)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="persona" value="Street Vibe" class="form-radio text-primary-blue">
                        <span class="ml-2">Street Vibe (Slang)</span>
                    </label>
                </div>

                <button id="translateBtn" class="w-full bg-accent-gold hover:bg-yellow-600 text-primary-blue font-bold py-3 rounded-xl transition duration-300 shadow-md">
                    Get Your Translation
                </button>

                <div id="translatorOutput" class="p-4 mt-4 bg-gray-100 border-l-4 border-accent-turq rounded-lg min-h-20">
                    <p class="text-gray-600">The AI-powered translation will appear here.</p>
                </div>
                <div id="translatorError" class="text-red-500 text-sm hidden"></div>
            </div>
        </section>

        <!-- Tab Content: Code-Switch Collab Arena -->
        <section id="collab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-accent-gold pb-2">Code-Switch Collab Arena: Share Your Voice</h2>

            <!-- Current Challenge -->
            <div class="bg-accent-turq/10 p-4 rounded-xl card mb-6">
                <h3 class="text-xl font-semibold text-primary-blue mb-2 flex items-center">
                    <i data-lucide="flame" class="w-6 h-6 mr-2 text-accent-gold"></i> Weekly Challenge: Post-Eid Vibe
                </h3>
                <p id="challengePrompt" class="text-gray-700 italic">"Write a short, witty Instagram caption (under 15 words) mixing Darija, French, and English to describe the feeling of returning to school after Eid break."</p>
            </div>

            <!-- Submission Form -->
            <div class="bg-white p-6 rounded-xl card mb-8">
                <h3 class="text-xl font-bold mb-4 text-primary-blue">Submit Your Code-Switch Script</h3>
                <textarea id="collabInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-turq focus:border-accent-turq resize-none text-gray-800" rows="2" maxlength="500" placeholder="Your creative code-switch response..."></textarea>
                <div class="text-right text-xs text-gray-500 mb-3"><span id="charCount">0</span>/500 characters</div>
                <button id="submitCollabBtn" class="w-full bg-primary-blue hover:bg-primary-blue/90 text-white font-bold py-2 rounded-xl transition duration-300 shadow-lg">
                    Post to the Arena
                </button>
                <div id="collabMessage" class="mt-2 text-center text-sm hidden"></div>
            </div>

            <!-- Arena Feed -->
            <h3 class="text-2xl font-bold mt-8 mb-4">Top Submissions <i data-lucide="star" class="inline w-5 h-5 text-accent-gold"></i></h3>
            <div id="collabFeed" class="scrollable-content space-y-4">
                <div id="loadingFeed" class="text-center text-gray-500 py-10">
                    Loading real-time submissions...
                </div>
                <!-- Submissions will be injected here -->
            </div>
        </section>

        <!-- Tab Content: Pronunciation Battle -->
        <section id="battle" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-accent-gold pb-2">Pronunciation Battle: Level Up Your Lugha</h2>
            <div class="bg-white p-6 rounded-xl card space-y-6">
                <div class="text-center">
                    <p class="text-lg font-medium text-gray-700 mb-2">Current Phrase Challenge (English):</p>
                    <p id="battlePhrase" class="text-2xl font-extrabold text-primary-blue p-4 bg-accent-turq/20 rounded-lg italic shadow-inner">
                        "The strategic ambiguity of global communication networks."
                    </p>
                </div>

                <!-- Simulation UI -->
                <div class="flex flex-col items-center space-y-4">
                    <button id="recordBtn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-full transition duration-300 shadow-xl disabled:opacity-50" disabled>
                        <i data-lucide="mic" class="w-8 h-8"></i>
                    </button>
                    <p id="recordStatus" class="text-sm text-gray-600">Click to Record (Feature Simulated)</p>
                    <button id="simulateBattleBtn" class="bg-accent-gold hover:bg-yellow-600 text-primary-blue font-bold py-2 px-6 rounded-xl transition duration-300 shadow-md">
                        Simulate AI Score
                    </button>
                </div>

                <!-- Score and Feedback -->
                <div id="battleFeedback" class="hidden border-t pt-4 space-y-3">
                    <h4 class="text-xl font-bold text-primary-blue">AI Feedback:</h4>
                    <p class="text-3xl font-extrabold text-green-600">Fluency Score: <span id="fluencyScore">89</span>/100</p>
                    <p class="text-gray-700">Suggestion: Try to enunciate the 't' in 'strategic' more clearly. Great pace!</p>
                </div>
                
                <!-- High Score Leaderboard (Simulated Firestore integration) -->
                <h3 class="text-xl font-bold mt-6 pt-4 border-t text-primary-blue">Top Voices</h3>
                <ul id="battleLeaderboard" class="space-y-2">
                    <li class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <span class="font-medium">User 123456...</span>
                        <span class="text-lg font-bold text-green-700">95/100</span>
                    </li>
                    <li class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <span class="font-medium">User 789012...</span>
                        <span class="text-lg font-bold text-green-700">91/100</span>
                    </li>
                </ul>
                <p class="text-xs text-gray-500 text-center">Note: Leaderboard is populated with simulated/placeholder data for this version.</p>
            </div>
        </section>

    </main>

    <!-- Modal for Upvote Confirmation -->
    <div id="upvoteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center card">
            <h3 class="text-xl font-bold text-primary-blue mb-4">Thank you!</h3>
            <p class="text-gray-700">Your upvote has been counted.</p>
            <button class="mt-4 bg-accent-turq hover:bg-teal-500 text-primary-blue font-bold py-2 px-4 rounded-xl transition duration-300" onclick="document.getElementById('upvoteModal').classList.add('hidden')">
                Close
            </button>
        </div>
    </div>
    
    <!-- Modal for Error/Message -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center card">
            <h3 id="modalTitle" class="text-xl font-bold text-red-600 mb-4">Error</h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <button class="mt-4 bg-accent-gold hover:bg-yellow-600 text-primary-blue font-bold py-2 px-4 rounded-xl transition duration-300" onclick="document.getElementById('messageModal').classList.add('hidden')">
                Close
            </button>
        </div>
    </div>


    <!-- JavaScript Section -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, limit, serverTimestamp, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = "AIzaSyB4mDje3rFXA115NlGkCZdfrFk5Ll3vpkE"; // Placeholder for the actual API key
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        let db;
        let auth;
        let userId = 'initializing';
        let isAuthReady = false;

        // --- Utility Functions ---

        /** Shows a custom modal message */
        function showModal(title, message, isError = true) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.remove('hidden');
            document.getElementById('modalTitle').classList.toggle('text-red-600', isError);
            document.getElementById('modalTitle').classList.toggle('text-primary-blue', !isError);
        }

        /** Exponential Backoff for API Calls */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /** Calls the Gemini API for text generation */
        async function callGeminiApi(userQuery, systemPrompt) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(GEMINI_API_URL, options);
                const result = await response.json();
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    const error = result.error?.message || "Unknown error during text generation.";
                    throw new Error(error);
                }
                return text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw new Error(`AI generation failed: ${error.message || 'Check console for details.'}`);
            }
        }

        // --- Firebase Initialization and Auth ---

        function initFirebase() {
            try {
                setLogLevel('debug'); // ADDED: For debugging Firebase issues and permissions
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId.substring(0, 6) + '...';
                    } else {
                        // Use a random ID if anonymous sign-in fails or user is null
                        userId = crypto.randomUUID();
                        document.getElementById('userIdDisplay').textContent = userId.substring(0, 6) + '...';
                    }
                    isAuthReady = true;
                    // Start Firestore listeners once Auth is ready
                    setupCollabArenaListener();
                });

                // Sign in using the custom token or anonymously
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(error => {
                        console.error("Custom token sign-in failed. Falling back to anonymous:", error);
                        signInAnonymously(auth).catch(err => {
                             console.error("Anonymous sign-in failed:", err);
                             showModal("Authentication Error", "Could not sign in to Firebase. Real-time features may be disabled.");
                        });
                    });
                } else {
                    signInAnonymously(auth).catch(err => {
                        console.error("Anonymous sign-in failed:", err);
                        showModal("Authentication Error", "Could not sign in to Firebase. Real-time features may be disabled.");
                    });
                }
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showModal("Configuration Error", "Firebase configuration is missing or incorrect. Please check the environment variables.");
            }
        }

        // --- Translator Logic (Gemini API) ---

        document.getElementById('translateBtn').addEventListener('click', async () => {
            const input = document.getElementById('translatorInput').value.trim();
            const outputDiv = document.getElementById('translatorOutput');
            const errorDiv = document.getElementById('translatorError');
            const persona = document.querySelector('input[name="persona"]:checked').value;
            
            errorDiv.classList.add('hidden');
            if (!input) {
                outputDiv.innerHTML = '<p class="text-red-500">Please enter a phrase to translate.</p>';
                return;
            }

            const loadingHTML = `
                <div class="flex items-center space-x-2 text-primary-blue">
                    <svg class="animate-spin h-5 w-5 text-accent-turq" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Analyzing Lugha for the '${persona}' persona...</span>
                </div>
            `;
            outputDiv.innerHTML = loadingHTML;

            let systemPrompt;
            switch (persona) {
                case 'Formal':
                    systemPrompt = "You are a professional language editor for academic or formal business correspondence in Morocco. Rephrase the user's input into either grammatically correct Modern Standard Arabic or formal, high-level French, depending on which language best suits the input. Do not include any Darija or slang. Keep it concise.";
                    break;
                case 'Corporate':
                    systemPrompt = "You are a world-class marketer. Rephrase the user's input into clear, professional, concise, and modern English, suitable for a resume, LinkedIn post, or a business email.";
                    break;
                case 'Street Vibe':
                    systemPrompt = "You are a Moroccan trendsetter and social media guru. Rephrase the user's input into the most popular, witty, and expressive slang and code-switching mix (using English and French) appropriate for a social media caption or chat. Focus on being creative and cool.";
                    break;
                default:
                    systemPrompt = "Rephrase the user's input into three versions: Formal French, Corporate English, and Street Vibe Code-Switched. Label each one clearly.";
            }

            try {
                const resultText = await callGeminiApi(input, systemPrompt);
                outputDiv.innerHTML = `<p class="whitespace-pre-wrap text-gray-800">${resultText}</p>`;
            } catch (error) {
                console.error("Translator Error:", error);
                outputDiv.innerHTML = '<p class="text-red-500">Translation failed. Please try again or check your input.</p>';
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // --- Collab Arena Logic (Firestore) ---

        const challengePrompt = document.getElementById('challengePrompt').textContent;
        const collabInput = document.getElementById('collabInput');
        const charCount = document.getElementById('charCount');

        collabInput.addEventListener('input', () => {
            charCount.textContent = collabInput.value.length;
        });

        document.getElementById('submitCollabBtn').addEventListener('click', async () => {
            if (!isAuthReady) {
                showModal("Error", "Authentication is still initializing. Please wait a moment.");
                return;
            }

            const submissionText = collabInput.value.trim();
            if (submissionText.length < 5) {
                showModal("Submission Error", "Your submission is too short. Be more creative!");
                return;
            }

            const collabMessage = document.getElementById('collabMessage');
            collabMessage.textContent = 'Posting submission...';
            collabMessage.classList.remove('hidden');
            collabMessage.classList.add('text-primary-blue');

            const collabRef = collection(db, 'artifacts', appId, 'public', 'data', 'collab_submissions');
            
            try {
                // NOTE: Using doc() without an argument lets Firestore auto-generate the ID
                await setDoc(doc(collabRef), { 
                    userId: userId,
                    prompt: challengePrompt,
                    submissionText: submissionText,
                    upvotes: 0,
                    upvoters: [], // Array to store user IDs who have upvoted
                    timestamp: serverTimestamp()
                });

                collabInput.value = '';
                charCount.textContent = '0';
                collabMessage.textContent = 'Awesome! Your submission is live.';
                setTimeout(() => collabMessage.classList.add('hidden'), 3000);

            } catch (e) {
                console.error("Error adding document: ", e);
                collabMessage.textContent = `Error posting: ${e.message}`;
                collabMessage.classList.add('text-red-500');
            }
        });

        async function handleUpvote(submissionId) {
            if (!isAuthReady) {
                showModal("Error", "Authentication is still initializing. Please wait a moment.");
                return;
            }
            if (userId === 'initializing') {
                 showModal("Error", "Please wait for user authentication to complete before upvoting.");
                return;
            }

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'collab_submissions', submissionId);
            
            try {
                // For this environment, we rely on the security rules to enforce unique votes.
                // We use arrayUnion to store the user ID, preventing double votes.
                await updateDoc(docRef, {
                    upvotes: incrementField, // Custom simulated increment (real update)
                    upvoters: arrayUnion(userId) // Add user ID to prevent re-voting
                });

                // Show modal confirmation (instead of alert)
                document.getElementById('upvoteModal').classList.remove('hidden');

            } catch (e) {
                // If the user ID is already in 'upvoters', the update might still succeed 
                // but the vote count might be off if not handled in rules. For now, rely on arrayUnion.
                console.error("Error upvoting document: ", e);
                showModal("Upvote Error", `Failed to upvote. You may have already voted or there was a system error: ${e.message}`);
            }
        }
        
        // Custom simple increment function simulation since updateDoc.increment is complex to manage client-side without full SDK setup
        // This is a placeholder value that will work with Firestore if rules allow it, otherwise it relies on arrayUnion logic.
        const incrementField = 1; 


        function renderCollabSubmissions(submissions) {
            const feedDiv = document.getElementById('collabFeed');
            feedDiv.innerHTML = ''; // Clear existing feed
            if (submissions.length === 0) {
                feedDiv.innerHTML = '<p class="text-center text-gray-500 italic py-10">No submissions yet. Be the first!</p>';
                return;
            }

            // Client-side sorting is now mandatory as orderBy was removed from the query
            // Sort by upvotes (descending)
            submissions.sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0));

            submissions.forEach(sub => {
                const isUpvoted = sub.upvoters && sub.upvoters.includes(userId);
                const upvoteBtnClass = isUpvoted ? 'bg-green-500 text-white' : 'bg-gray-200 text-primary-blue hover:bg-accent-turq/50';

                const subElement = document.createElement('div');
                subElement.className = 'bg-white p-4 rounded-xl card border-l-4 border-accent-turq shadow-sm flex justify-between items-start';
                subElement.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-mono text-gray-500 mb-1">By: ${sub.userId.substring(0, 8)}... (${new Date(sub.timestamp?.toDate()).toLocaleDateString()})</p>
                        <p class="text-lg text-gray-800 font-medium whitespace-pre-wrap">${sub.submissionText}</p>
                    </div>
                    <div class="ml-4 flex flex-col items-center space-y-2">
                        <button id="upvote-${sub.id}" class="upvote-btn p-2 rounded-full transition duration-150 ${upvoteBtnClass}" 
                                ${isUpvoted ? 'disabled' : ''}
                                data-id="${sub.id}">
                            <i data-lucide="chevron-up" class="w-5 h-5"></i>
                        </button>
                        <span class="text-xl font-bold text-primary-blue">${sub.upvotes || 0}</span>
                        <span class="text-xs text-gray-500">Votes</span>
                    </div>
                `;
                
                feedDiv.appendChild(subElement);
                lucide.createIcons(); // Re-render Lucide icons for new elements
            });
            
            // Attach upvote handlers after rendering
            document.querySelectorAll('.upvote-btn').forEach(button => {
                button.onclick = () => handleUpvote(button.getAttribute('data-id'));
            });
        }

        function setupCollabArenaListener() {
            if (!isAuthReady || !db) return;

            const collabRef = collection(db, 'artifacts', appId, 'public', 'data', 'collab_submissions');
            
            // Query: Removed orderBy('upvotes', 'desc') to prevent index errors. Data will be sorted client-side.
            const q = query(collabRef, limit(15)); 

            onSnapshot(q, (snapshot) => {
                const submissions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Call render function which includes client-side sorting
                renderCollabSubmissions(submissions);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                document.getElementById('collabFeed').innerHTML = `<p class="text-red-500 text-center py-10">Error loading feed: ${error.message}. Check the console for Firebase debug logs.</p>`;
            });
        }


        // --- Pronunciation Battle Logic (Simulated) ---

        document.getElementById('simulateBattleBtn').addEventListener('click', () => {
            // Generate a simulated score
            const score = Math.floor(Math.random() * 20) + 75; // Score between 75 and 95
            const feedbackDiv = document.getElementById('battleFeedback');
            const fluencyScore = document.getElementById('fluencyScore');
            
            fluencyScore.textContent = score;
            feedbackDiv.classList.remove('hidden');

            let suggestion = "Excellent command of the phrase! Keep up the great work.";
            if (score < 80) {
                suggestion = "Focus on the vowel sounds and maintain a steady pace.";
                fluencyScore.classList.replace('text-green-600', 'text-yellow-600');
            } else if (score < 90) {
                suggestion = "Minor improvements needed on word stress. Very good overall.";
                fluencyScore.classList.replace('text-yellow-600', 'text-green-600');
            } else {
                fluencyScore.classList.replace('text-yellow-600', 'text-green-600');
            }

            feedbackDiv.querySelector('p:last-child').textContent = `Suggestion: ${suggestion}`;
        });


        // --- UI/Tab Switching Logic ---
        
        // Making switchTab a global function by attaching it to window so inline onclick handlers can find it.
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.onclick.toString().includes(`'${tabId}'`)) {
                    button.classList.add('active');
                }
            });
        }

        // Initialize App on Load
        window.onload = () => {
            initFirebase();
            lucide.createIcons();
            // Initial tab is set to translator
            window.switchTab('translator');
        };

    </script>
</body>
</html>